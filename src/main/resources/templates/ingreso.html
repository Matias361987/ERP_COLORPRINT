<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Ingreso ColorPrint</title>
    <link rel="icon" type="image/png" th:href="@{/images/favicon.png}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f8; font-family: 'Roboto', sans-serif; font-size: 0.9rem; }
        .navbar-custom { background: linear-gradient(90deg, #1a1a1a, #2c3e50); }
        .nav-link { color: rgba(255,255,255,0.7); }
        .nav-link.active { color: #ffca2c !important; font-weight: bold; }
        .btn-ingresar { background-color: #ffca2c; color: #000; font-weight: 800; border: none; }
        .btn-ingresar:hover { background-color: #ffc107; }
        .table-input th { background-color: #212529; color: white; font-size: 0.7rem; text-transform: uppercase; vertical-align: middle; text-align: center;}
        .table-input td { padding: 4px; vertical-align: middle; }
        .form-control-xs, .form-select-xs { border-radius: 0; border: 1px solid #dee2e6; font-size: 0.8rem; padding: 4px; }
        .form-control-xs:focus { border-color: #ffca2c; box-shadow: inset 0 0 0 1px #ffca2c; z-index: 2; position: relative; }
        .btn-remove { color: #dc3545; cursor: pointer; transition: 0.2s; font-size: 1rem; }
        .btn-duplicate { color: #0d6efd; cursor: pointer; transition: 0.2s; font-size: 1rem; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-custom navbar-dark mb-4 shadow-sm">
    <div class="container-fluid px-4">
        <a class="navbar-brand p-0" href="#">
            <img th:src="@{/images/logocolorprint.png}" alt="ColorPrint" style="height: 40px; object-fit: contain;">
        </a>
        <div class="navbar-nav ms-auto">
            <a class="nav-link active me-3" href="/ingreso">INGRESO</a>
            <a class="nav-link me-3" href="/pauta">PAUTA</a>
            <a class="nav-link me-3" href="/estadisticas">ESTADÍSTICAS</a>
            <a class="nav-link me-3" href="/inventario">INVENTARIO</a>
            <a class="nav-link me-3" href="/calendario">INSTALACIONES</a>
            <form th:action="@{/logout}" method="post" class="d-inline"><button class="btn nav-link border-0 bg-transparent fw-bold">SALIR</button></form>
        </div>
    </div>
</nav>

<div class="container-fluid px-2">
    <form th:action="@{/guardar}" method="post" id="formMasivo">

        <div class="card shadow-sm border-0 mb-3">
            <div class="card-header bg-white fw-bold py-2"><i class="fa-solid fa-circle-info me-2 text-primary"></i>DATOS GENERALES OT</div>
            <div class="card-body bg-light py-3">
                <div class="row g-3">
                    <div class="col-md-2"><label class="form-label small fw-bold text-muted mb-1">OT #</label><input type="text" name="ot" class="form-control fw-bold text-center border-primary" placeholder="Auto"></div>
                    <div class="col-md-3"><label class="form-label small fw-bold text-muted mb-1">CLIENTE</label><input type="text" name="cliente" class="form-control" required></div>
                    <div class="col-md-2"><label class="form-label small fw-bold text-muted mb-1">VENDEDORA</label><select name="vendedora" class="form-select bg-info bg-opacity-10" required><option value="" disabled selected>Elegir...</option><option value="PAMELA">PAMELA</option><option value="ANITA">ANITA</option><option value="OFICINA">OFICINA</option></select></div>
                    <div class="col-md-2"><label class="form-label small fw-bold text-muted mb-1">FECHA ENTREGA</label><input type="date" name="fechaEntrega" class="form-control" required></div>
                    <div class="col-md-3"><label class="form-label small fw-bold text-muted mb-1">INICIAR EN</label><select name="estadoActual" class="form-select bg-warning bg-opacity-10"><option value="REVISAR_ARCHIVO">Revisar Archivo</option><option value="IMPRIMIR_VB">Imprimir VB</option><option value="COLA_DE_IMPRESION">Cola Producción</option></select></div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm border-0 mb-5">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-bordered table-input mb-0" id="tablaItems">
                        <thead>
                        <tr>
                            <th width="2%">#</th>
                            <th width="15%">TEMA / ARCHIVO</th>
                            <th width="10%">MÁQUINA</th>
                            <th width="6%">RES.</th>
                            <th width="8%">SUSTRATO</th>
                            <th width="6%">ANCHO</th>
                            <th width="6%">ALTO</th>
                            <th width="5%">CANT.</th>
                            <th width="15%">TERMINACIONES</th>
                            <th width="18%">LOGÍSTICA</th>
                            <th width="7%">ACCIONES</th>
                        </tr>
                        </thead>
                        <tbody id="tbodyItems">
                        <tr class="fila-item">
                            <td class="text-center fw-bold row-index text-muted">1</td>
                            <td><input type="text" name="tema" class="form-control form-control-xs" required></td>
                            <td><input type="text" name="maquina" class="form-control form-control-xs"></td>
                            <td><select name="resolucion" class="form-select form-select-xs"><option value="Alta">Alta</option><option value="Baja">Baja</option></select></td>
                            <td><input type="text" name="sustrato" class="form-control form-control-xs"></td>
                            <td><input type="number" step="0.01" name="ancho" class="form-control form-control-xs text-center" oninput="calc(this)"></td>
                            <td><input type="number" step="0.01" name="alto" class="form-control form-control-xs text-center" oninput="calc(this)"></td>
                            <td><input type="number" name="cantidad" class="form-control form-control-xs text-center fw-bold" value="1" oninput="calc(this)"></td>
                            <td><input type="text" name="terminaciones" class="form-control form-control-xs" placeholder="..."><div class="text-end text-primary fw-bold small mt-1 span-m2">0.00 m²</div></td>
                            <td>
                                <div class="d-flex flex-column gap-1">
                                    <select name="tipoDespacho" class="form-select form-select-xs bg-light">
                                        <option value="Retiro Taller">Retiro Taller</option>
                                        <option value="Despacho Santiago">Despacho Stgo</option>
                                        <option value="Envío Región">Envío Región</option>
                                        <option value="Instalacion">INSTALACIÓN</option>
                                    </select>
                                    <input type="text" name="despacharA" class="form-control form-control-xs" placeholder="Dirección..." required>
                                </div>
                            </td>
                            <td class="text-center">
                                <i class="fa-solid fa-copy btn-duplicate me-2" onclick="duplicarFila(this)"></i>
                                <i class="fa-solid fa-trash-can btn-remove" onclick="borrarFila(this)"></i>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer bg-white d-flex justify-content-between align-items-center py-3">
                <button type="button" class="btn btn-outline-dark btn-sm" onclick="agregarFila()"><i class="fa-solid fa-plus me-1"></i> AGREGAR OTRA FILA</button>
                <button type="submit" class="btn btn-ingresar px-5 rounded-3 shadow-sm"><i class="fa-solid fa-floppy-disk me-2"></i> GUARDAR ORDEN COMPLETA</button>
            </div>
        </div>
    </form>
</div>

<script>
    function actualizarIndices() {
        let filas = document.querySelectorAll('#tbodyItems tr');
        filas.forEach((fila, index) => { fila.querySelector('.row-index').innerText = index + 1; });
    }
    function calc(element) {
        let row = element.closest('tr');
        let ancho = row.querySelector('input[name="ancho"]').valueAsNumber || 0;
        let alto = row.querySelector('input[name="alto"]').valueAsNumber || 0;
        let cant = row.querySelector('input[name="cantidad"]').valueAsNumber || 0;
        let m2 = (ancho * alto * cant) / 10000;
        row.querySelector('.span-m2').innerText = m2.toFixed(2) + " m²";
    }
    function agregarFila() {
        let tbody = document.getElementById('tbodyItems');
        let primeraFila = tbody.querySelector('tr');
        let nuevaFila = primeraFila.cloneNode(true);
        nuevaFila.querySelectorAll('input').forEach(input => input.value = '');
        nuevaFila.querySelector('input[name="cantidad"]').value = 1;
        nuevaFila.querySelector('select[name="resolucion"]').value = 'Alta';
        nuevaFila.querySelector('select[name="tipoDespacho"]').value = 'Retiro Taller';
        nuevaFila.querySelector('.span-m2').innerText = '0.00 m²';
        tbody.appendChild(nuevaFila);
        actualizarIndices();
    }
    function duplicarFila(btn) {
        let filaActual = btn.closest('tr');
        let nuevaFila = filaActual.cloneNode(true);
        filaActual.parentNode.insertBefore(nuevaFila, filaActual.nextSibling);
        actualizarIndices();
        calc(nuevaFila.querySelector('input[name="ancho"]'));
    }
    function borrarFila(btn) {
        let filas = document.querySelectorAll('#tbodyItems tr');
        if (filas.length > 1) { btn.closest('tr').remove(); actualizarIndices(); } else { let inputs = btn.closest('tr').querySelectorAll('input'); inputs.forEach(input => input.value = ''); }
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>